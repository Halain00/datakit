<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>CI_web_utils (datakit-ci.CI_web_utils)</title><link rel="stylesheet" href="../../odoc.css"/><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class="content"><header><nav><a href="../index.html">Up</a> â€“ <a href="../index.html">datakit-ci</a> &#x00BB; CI_web_utils</nav><h1>Module <code>CI_web_utils</code></h1></header><div class="spec module" id="module-Wm"><a href="#module-Wm" class="anchor"></a><code><span class="keyword">module</span> Wm : Webmachine.S <span class="keyword">with</span> <span class="keyword">type</span> <span>'a <a href="index.html#module-Wm">Wm</a>.io</span> = <span><span class="type-var">'a</span> Lwt.t</span></code></div><dl><dt class="spec type" id="type-role"><a href="#type-role" class="anchor"></a><code><span class="keyword">type</span> role</code> = <code>[ </code><table class="variant"><tr id="type-role.Reader" class="anchored"><td class="def constructor"><a href="#type-role.Reader" class="anchor"></a><code>| </code><code>`Reader</code></td></tr><tr id="type-role.LoggedIn" class="anchored"><td class="def constructor"><a href="#type-role.LoggedIn" class="anchor"></a><code>| </code><code>`LoggedIn</code></td></tr><tr id="type-role.Builder" class="anchored"><td class="def constructor"><a href="#type-role.Builder" class="anchor"></a><code>| </code><code>`Builder</code></td></tr><tr id="type-role.Admin" class="anchored"><td class="def constructor"><a href="#type-role.Admin" class="anchor"></a><code>| </code><code>`Admin</code></td></tr></table><code> ]</code></dt><dd><p>Roles are:</p><ul><li><code>Reader</code> permitted to look at the CI state, build logs, etc</li><li><code>LoggedIn</code> must be logged in (not anonymous)</li><li><code>Builder</code> permitted to control the builds (cancel, rebuild)</li><li><code>Admin</code> is an administrator</li></ul></dd></dl><div class="spec module" id="module-User"><a href="#module-User" class="anchor"></a><code><span class="keyword">module</span> <a href="User/index.html">User</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div><div class="spec module" id="module-Auth"><a href="#module-Auth" class="anchor"></a><code><span class="keyword">module</span> <a href="Auth/index.html">Auth</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div><dl><dt class="spec type" id="type-server"><a href="#type-server" class="anchor"></a><code><span class="keyword">type</span> server</code></dt></dl><dl><dt class="spec value" id="val-server"><a href="#val-server" class="anchor"></a><code><span class="keyword">val</span> server : <span>auth:<a href="Auth/index.html#type-t">Auth.t</a></span> <span>&#45;&gt;</span> <span>web_config:<a href="../CI_web_templates/index.html#type-t">CI_web_templates.t</a></span> <span>&#45;&gt;</span> <span>session_backend:<span>[&lt; `Memory <span><span>| `Redis</span> of <span>Redis_lwt.Client.connection Lwt_pool.t</span></span> ]</span></span> <span>&#45;&gt;</span> <span>public_address:Uri.t</span> <span>&#45;&gt;</span> <a href="index.html#type-server">server</a></code></dt><dt class="spec value" id="val-web_config"><a href="#val-web_config" class="anchor"></a><code><span class="keyword">val</span> web_config : <a href="index.html#type-server">server</a> <span>&#45;&gt;</span> <a href="../CI_web_templates/index.html#type-t">CI_web_templates.t</a></code></dt></dl><div class="spec module" id="module-Session_data"><a href="#module-Session_data" class="anchor"></a><code><span class="keyword">module</span> <a href="Session_data/index.html">Session_data</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div><div class="spec class-type" id="class-type-resource"><a href="#class-type-resource" class="anchor"></a><code><span class="keyword">class</span> <span class="keyword">type</span>  <a href="class-type-resource/index.html">resource</a> = <span class="keyword">object</span> ... <span class="keyword">end</span></code></div><dl><dt class="spec class" id="class-static"><a href="#class-static" class="anchor"></a><code><span class="keyword">class</span>  <a href="class-static/index.html">static</a> : valid:Str.regexp <span>&#45;&gt;</span> mime_type:<span>(Uri.t <span>&#45;&gt;</span> <span>string option</span>)</span> <span>&#45;&gt;</span> string <span>&#45;&gt;</span> <a href="class-type-resource/index.html">resource</a></code></dt><dd><p><code>new static ~valid ~mime_type dir</code> serves up files from the directory <code>dir</code>, taking the leafname from the context. Names must match the RE <code>valid</code> and the MIME type returned will be <code>mime_type uri</code>.</p></dd></dl><dl><dt class="spec class" id="class-static_crunch"><a href="#class-static_crunch" class="anchor"></a><code><span class="keyword">class</span>  <a href="class-static_crunch/index.html">static_crunch</a> : mime_type:<span>(Uri.t <span>&#45;&gt;</span> <span>string option</span>)</span> <span>&#45;&gt;</span> <span>(string <span>&#45;&gt;</span> <span>string option</span>)</span> <span>&#45;&gt;</span> <a href="class-type-resource/index.html">resource</a></code></dt><dd><p><code>new static_crunch ~mime_type read</code> serves up files using the function <code>read</code>, taking the path from the context. The MIME type returned will be <code>mime_type uri</code>.</p></dd></dl><dl><dt class="spec class" id="class-resource_with_session"><a href="#class-resource_with_session" class="anchor"></a><code><span class="keyword">class</span> <span class="keyword">virtual</span>  <a href="class-resource_with_session/index.html">resource_with_session</a> : <a href="index.html#type-server">server</a> <span>&#45;&gt;</span> <span class="keyword">object</span> ... <span class="keyword">end</span></code></dt><dd><p><code>resource_with_session</code> ensures there is a session for each request.</p></dd></dl><dl><dt class="spec class" id="class-login_page"><a href="#class-login_page" class="anchor"></a><code><span class="keyword">class</span>  <a href="class-login_page/index.html">login_page</a> : <a href="index.html#type-server">server</a> <span>&#45;&gt;</span> <a href="class-type-resource/index.html">resource</a></code></dt><dd><p>Page to serve at <code>/auth/login</code>.</p></dd></dl><dl><dt class="spec class" id="class-auth_intro"><a href="#class-auth_intro" class="anchor"></a><code><span class="keyword">class</span>  <a href="class-auth_intro/index.html">auth_intro</a> : <a href="index.html#type-server">server</a> <span>&#45;&gt;</span> <a href="class-type-resource/index.html">resource</a></code></dt><dd><p>Page to serve at <code>/auth/intro/:token</code>.</p></dd></dl><dl><dt class="spec class" id="class-auth_setup"><a href="#class-auth_setup" class="anchor"></a><code><span class="keyword">class</span>  <a href="class-auth_setup/index.html">auth_setup</a> : <a href="index.html#type-server">server</a> <span>&#45;&gt;</span> <a href="class-type-resource/index.html">resource</a></code></dt><dd><p>Page to serve at <code>/auth/setup</code>.</p></dd></dl><dl><dt class="spec class" id="class-github_callback"><a href="#class-github_callback" class="anchor"></a><code><span class="keyword">class</span>  <a href="class-github_callback/index.html">github_callback</a> : <a href="index.html#type-server">server</a> <span>&#45;&gt;</span> <a href="class-type-resource/index.html">resource</a></code></dt><dd><p>Page to serve at <code>/auth/github-callback</code></p></dd></dl><dl><dt class="spec class" id="class-protected_page"><a href="#class-protected_page" class="anchor"></a><code><span class="keyword">class</span> <span class="keyword">virtual</span>  <a href="class-protected_page/index.html">protected_page</a> : <a href="index.html#type-server">server</a> <span>&#45;&gt;</span> <span class="keyword">object</span> ... <span class="keyword">end</span></code></dt><dd><p>The <code>is_authorized</code> method checks that the session has an associated user and asks the user to log in if not. <code>authenticated_user</code> returns the name of the user once <code>is_authorized</code> has completed.</p></dd></dl><dl><dt class="spec class" id="class-post_page"><a href="#class-post_page" class="anchor"></a><code><span class="keyword">class</span> <span class="keyword">virtual</span>  <a href="class-post_page/index.html">post_page</a> : <a href="index.html#type-server">server</a> <span>&#45;&gt;</span> <span class="keyword">object</span> ... <span class="keyword">end</span></code></dt><dd><p><code>post_page</code> accepts form POST submissions. It overrides <code>forbidden</code> to check that the CSRF token is present and correct.</p></dd></dl><dl><dt class="spec class" id="class-logout_page"><a href="#class-logout_page" class="anchor"></a><code><span class="keyword">class</span>  <a href="class-logout_page/index.html">logout_page</a> : <a href="index.html#type-server">server</a> <span>&#45;&gt;</span> <a href="class-type-resource/index.html">resource</a></code></dt><dd><p>Posting to this page logs the user out and redirects to <code>/</code>.</p></dd></dl><dl><dt class="spec value" id="val-serve"><a href="#val-serve" class="anchor"></a><code><span class="keyword">val</span> serve : <span>mode:Conduit_lwt_unix.server</span> <span>&#45;&gt;</span> <span>routes:<span><span>(string * <span>(unit <span>&#45;&gt;</span> <span>Cohttp_lwt.Body.t <a href="index.html#module-Wm">Wm</a>.resource</span>)</span>)</span> list</span></span> <span>&#45;&gt;</span> <span>unit Lwt.t</span></code></dt><dd><p><code>serve ~mode ~routes</code> runs a web-server listening on <code>mode</code> that dispatches incoming requests using <code>routes</code>.</p></dd></dl><div class="spec class" id="class-html_page"><a href="#class-html_page" class="anchor"></a><code><span class="keyword">class</span> <span class="keyword">virtual</span>  <a href="class-html_page/index.html">html_page</a> : <a href="index.html#type-server">server</a> <span>&#45;&gt;</span> <span class="keyword">object</span> ... <span class="keyword">end</span></code></div><div class="spec class" id="class-form_page"><a href="#class-form_page" class="anchor"></a><code><span class="keyword">class</span> <span class="keyword">virtual</span> 'a <a href="class-form_page/index.html">form_page</a> : <a href="index.html#type-server">server</a> <span>&#45;&gt;</span> <span class="keyword">object</span> ... <span class="keyword">end</span></code></div><dl><dt class="spec class" id="class-github_auth_settings"><a href="#class-github_auth_settings" class="anchor"></a><code><span class="keyword">class</span>  <a href="class-github_auth_settings/index.html">github_auth_settings</a> : <a href="index.html#type-server">server</a> <span>&#45;&gt;</span> <a href="class-type-resource/index.html">resource</a></code></dt><dd><p>The GitHub authentication settings page.</p></dd></dl></div></body></html>