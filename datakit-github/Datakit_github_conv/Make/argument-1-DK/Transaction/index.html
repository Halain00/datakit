<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Transaction (datakit-github.Datakit_github_conv.Make.1-DK.Transaction)</title><link rel="stylesheet" href="../../../../../odoc.css"/><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class="content"><header><nav><a href="../index.html">Up</a> â€“ <a href="../../../../index.html">datakit-github</a> &#x00BB; <a href="../../../index.html">Datakit_github_conv</a> &#x00BB; <a href="../../index.html">Make</a> &#x00BB; <a href="../index.html">1-DK</a> &#x00BB; Transaction</nav><h1>Module <code>1-DK.Transaction</code></h1><nav class="toc"><ul><li><a href="#reading">Reading</a></li><li><a href="#writing">Writing</a></li><li><a href="#finishing">Finishing</a></li><li><a href="#merging-and-history">Merging and history</a></li></ul></nav></header><aside><p>All changes to a branch are made in transactions. When a transaction is committed, it is merged with the current contents of the branch.</p></aside><section><header><h3 id="reading"><a href="#reading" class="anchor"></a>Reading</h3></header><div><div class="spec include"><div class="doc"><details open="open"><summary><span class="def"><code><span class="keyword">include</span> <a href="../../../../../datakit-client/Datakit_client/index.html#module-type-READABLE_TREE">Datakit_client.READABLE_TREE</a> <span class="keyword">with</span> <span class="keyword">type</span> <span>'a <a href="../../../../../datakit-client/Datakit_client/module-type-READABLE_TREE/index.html#type-result">result</a></span> := <span><span class="type-var">'a</span> <a href="../index.html#type-result">result</a></span></code></span></summary><dl><dt class="spec type" id="type-t"><a href="#type-t" class="anchor"></a><code><span class="keyword">type</span> t</code></dt><dd><p>The type for trees.</p></dd></dl><dl><dt class="spec type" id="type-result"><a href="#type-result" class="anchor"></a><code><span class="keyword">type</span> <span>+'a result</span></code></dt><dd><p>The type for results.</p></dd></dl><dl><dt class="spec value" id="val-read"><a href="#val-read" class="anchor"></a><code><span class="keyword">val</span> read : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../../../../../datakit-client/Datakit_client/Path/index.html#type-t">Datakit_client.Path.t</a> <span>&#45;&gt;</span> <span><a href="../../../../../datakit-client/Datakit_client/index.html#type-value">Datakit_client.value</a> <a href="index.html#type-result">result</a></span></code></dt><dd><p><code>read t path</code> is the contents of the object at the <code>path</code>.</p></dd></dl><dl><dt class="spec value" id="val-stat"><a href="#val-stat" class="anchor"></a><code><span class="keyword">val</span> stat : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../../../../../datakit-client/Datakit_client/Path/index.html#type-t">Datakit_client.Path.t</a> <span>&#45;&gt;</span> <span><span><a href="../../../../../datakit-client/Datakit_client/index.html#type-stat">Datakit_client.stat</a> option</span> <a href="index.html#type-result">result</a></span></code></dt><dd><p><code>stat t path</code> is the metadata of the object at <code>path</code>.</p></dd></dl><dl><dt class="spec value" id="val-exists"><a href="#val-exists" class="anchor"></a><code><span class="keyword">val</span> exists : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../../../../../datakit-client/Datakit_client/Path/index.html#type-t">Datakit_client.Path.t</a> <span>&#45;&gt;</span> <span>bool <a href="index.html#type-result">result</a></span></code></dt><dd><p><code>exists t path</code> is <code>true</code> if <code>stat t path</code> isn't <code>None</code>.</p></dd></dl><dl><dt class="spec value" id="val-exists_file"><a href="#val-exists_file" class="anchor"></a><code><span class="keyword">val</span> exists_file : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../../../../../datakit-client/Datakit_client/Path/index.html#type-t">Datakit_client.Path.t</a> <span>&#45;&gt;</span> <span>bool <a href="index.html#type-result">result</a></span></code></dt><dd><p><code>exists_file t path</code> is similar to <a href="index.html#val-exists"><code>exists</code></a> but for files only.</p></dd></dl><dl><dt class="spec value" id="val-exists_dir"><a href="#val-exists_dir" class="anchor"></a><code><span class="keyword">val</span> exists_dir : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../../../../../datakit-client/Datakit_client/Path/index.html#type-t">Datakit_client.Path.t</a> <span>&#45;&gt;</span> <span>bool <a href="index.html#type-result">result</a></span></code></dt><dd><p><code>exists_dir t path</code> is similar to <a href="index.html#val-exists"><code>exists</code></a> but for directories only.</p></dd></dl><dl><dt class="spec value" id="val-read_file"><a href="#val-read_file" class="anchor"></a><code><span class="keyword">val</span> read_file : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../../../../../datakit-client/Datakit_client/Path/index.html#type-t">Datakit_client.Path.t</a> <span>&#45;&gt;</span> <span>Cstruct.t <a href="index.html#type-result">result</a></span></code></dt><dd><p><code>read_file t path</code> resolves <code>path</code> to a file, or returns an error if it isn't a file.</p></dd></dl><dl><dt class="spec value" id="val-read_dir"><a href="#val-read_dir" class="anchor"></a><code><span class="keyword">val</span> read_dir : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../../../../../datakit-client/Datakit_client/Path/index.html#type-t">Datakit_client.Path.t</a> <span>&#45;&gt;</span> <span><span>string list</span> <a href="index.html#type-result">result</a></span></code></dt><dd><p><code>read_dir t path</code> resolves <code>path</code> to a directory, or returns an error if it isn't one.</p></dd></dl><dl><dt class="spec value" id="val-read_link"><a href="#val-read_link" class="anchor"></a><code><span class="keyword">val</span> read_link : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../../../../../datakit-client/Datakit_client/Path/index.html#type-t">Datakit_client.Path.t</a> <span>&#45;&gt;</span> <span>string <a href="index.html#type-result">result</a></span></code></dt><dd><p><code>read_link t path</code> resolves <code>path</code> to a symlink, or returns an error if it isn't one.</p></dd></dl></details></div></div></div></section><section><header><h3 id="writing"><a href="#writing" class="anchor"></a>Writing</h3></header><dl><dt class="spec value" id="val-create_dir"><a href="#val-create_dir" class="anchor"></a><code><span class="keyword">val</span> create_dir : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../../../../../datakit-client/Datakit_client/Path/index.html#type-t">Datakit_client.Path.t</a> <span>&#45;&gt;</span> <span>unit <a href="../index.html#type-result">result</a></span></code></dt><dd><p><code>create_dir t path</code> creates the directory <code>path</code>.</p></dd></dl><dl><dt class="spec value" id="val-create_file"><a href="#val-create_file" class="anchor"></a><code><span class="keyword">val</span> create_file : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../../../../../datakit-client/Datakit_client/Path/index.html#type-t">Datakit_client.Path.t</a> <span>&#45;&gt;</span> <span>?&#8288;executable:bool</span> <span>&#45;&gt;</span> Cstruct.t <span>&#45;&gt;</span> <span>unit <a href="../index.html#type-result">result</a></span></code></dt><dd><p><code>create_file t path ?executable content</code> creates the file <code>path</code>.</p></dd></dl><dl><dt class="spec value" id="val-create_symlink"><a href="#val-create_symlink" class="anchor"></a><code><span class="keyword">val</span> create_symlink : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../../../../../datakit-client/Datakit_client/Path/index.html#type-t">Datakit_client.Path.t</a> <span>&#45;&gt;</span> string <span>&#45;&gt;</span> <span>unit <a href="../index.html#type-result">result</a></span></code></dt><dd><p><code>create_symlink t path target</code> creates the symlink <code>path</code>.</p></dd></dl><dl><dt class="spec value" id="val-replace_file"><a href="#val-replace_file" class="anchor"></a><code><span class="keyword">val</span> replace_file : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../../../../../datakit-client/Datakit_client/Path/index.html#type-t">Datakit_client.Path.t</a> <span>&#45;&gt;</span> Cstruct.t <span>&#45;&gt;</span> <span>unit <a href="../index.html#type-result">result</a></span></code></dt><dd><p><code>replace_file t path new_content</code> changes the content of the existing file <code>path</code>.</p></dd></dl><dl><dt class="spec value" id="val-create_or_replace_file"><a href="#val-create_or_replace_file" class="anchor"></a><code><span class="keyword">val</span> create_or_replace_file : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../../../../../datakit-client/Datakit_client/Path/index.html#type-t">Datakit_client.Path.t</a> <span>&#45;&gt;</span> Cstruct.t <span>&#45;&gt;</span> <span>unit <a href="../index.html#type-result">result</a></span></code></dt><dd><p><code>create_or_replace_file t path content</code> uses either <code>create_file</code> or <code>replace_file</code> as appropriate to set the contents.</p></dd></dl><dl><dt class="spec value" id="val-set_executable"><a href="#val-set_executable" class="anchor"></a><code><span class="keyword">val</span> set_executable : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../../../../../datakit-client/Datakit_client/Path/index.html#type-t">Datakit_client.Path.t</a> <span>&#45;&gt;</span> bool <span>&#45;&gt;</span> <span>unit <a href="../index.html#type-result">result</a></span></code></dt><dd><p><code>set_executable t path flag</code> marks the file at <code>path</code> as executable or not.</p></dd></dl><dl><dt class="spec value" id="val-remove"><a href="#val-remove" class="anchor"></a><code><span class="keyword">val</span> remove : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../../../../../datakit-client/Datakit_client/Path/index.html#type-t">Datakit_client.Path.t</a> <span>&#45;&gt;</span> <span>unit <a href="../index.html#type-result">result</a></span></code></dt><dd><p><code>remove t path</code> removes <code>path</code>. If <code>path</code> is a directory then the entire subtree is removed.</p></dd></dl><dl><dt class="spec value" id="val-truncate"><a href="#val-truncate" class="anchor"></a><code><span class="keyword">val</span> truncate : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../../../../../datakit-client/Datakit_client/Path/index.html#type-t">Datakit_client.Path.t</a> <span>&#45;&gt;</span> int64 <span>&#45;&gt;</span> <span>unit <a href="../index.html#type-result">result</a></span></code></dt><dd><p><code>truncate t path length</code> sets the length of the file at <code>path</code> to <code>length</code>. If <code>length</code> is longer than the current length, the file is padded with zero bytes.</p></dd></dl><dl><dt class="spec value" id="val-make_dirs"><a href="#val-make_dirs" class="anchor"></a><code><span class="keyword">val</span> make_dirs : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../../../../../datakit-client/Datakit_client/Path/index.html#type-t">Datakit_client.Path.t</a> <span>&#45;&gt;</span> <span>unit <a href="../index.html#type-result">result</a></span></code></dt><dd><p><code>make_dirs t path</code> ensures that <code>path</code> exists and is a directory, creating it and any missing parents as necessary.</p></dd></dl></section><section><header><h3 id="finishing"><a href="#finishing" class="anchor"></a>Finishing</h3></header><dl><dt class="spec value" id="val-commit"><a href="#val-commit" class="anchor"></a><code><span class="keyword">val</span> commit : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span>message:string</span> <span>&#45;&gt;</span> <span>unit <a href="../index.html#type-result">result</a></span></code></dt><dd><p><code>commit t ~message</code> creates a new commit with the given log message and the current contents of the transaction and then merges it into the branch from which the transaction was created. The transaction cannot be used after calling this.</p></dd></dl><dl><dt class="spec value" id="val-abort"><a href="#val-abort" class="anchor"></a><code><span class="keyword">val</span> abort : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span>unit <a href="../index.html#type-result">result</a></span></code></dt><dd><p><code>abort t</code> aborts the transaction without committing it. The transaction cannot be used after calling this.</p></dd></dl></section><section><header><h3 id="merging-and-history"><a href="#merging-and-history" class="anchor"></a>Merging and history</h3></header><dl><dt class="spec type" id="type-merge_inputs"><a href="#type-merge_inputs" class="anchor"></a><code><span class="keyword">type</span> merge_inputs</code><code> = </code><code>{</code><table class="record"><tr id="type-merge_inputs.ours" class="anchored"><td class="def field"><a href="#type-merge_inputs.ours" class="anchor"></a><code>ours : <a href="../Tree/index.html#type-t">Tree.t</a>;</code></td></tr><tr id="type-merge_inputs.theirs" class="anchored"><td class="def field"><a href="#type-merge_inputs.theirs" class="anchor"></a><code>theirs : <a href="../Tree/index.html#type-t">Tree.t</a>;</code></td></tr><tr id="type-merge_inputs.base" class="anchored"><td class="def field"><a href="#type-merge_inputs.base" class="anchor"></a><code>base : <a href="../Tree/index.html#type-t">Tree.t</a>;</code></td></tr></table><code>}</code></dt><dd><p>When performing a merge, these three directories can be used to calculate the final result. <code>ours</code> is the previous contents of the transaction, <code>theirs</code> is the commit being merged and <code>base</code> is a least common ancestor. If there is no common ancestor then <code>base</code> is an empty tree.</p></dd></dl><dl><dt class="spec value" id="val-merge"><a href="#val-merge" class="anchor"></a><code><span class="keyword">val</span> merge : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../Commit/index.html#type-t">Commit.t</a> <span>&#45;&gt;</span> <span><span>(<a href="index.html#type-merge_inputs">merge_inputs</a> * <span><a href="../../../../../datakit-client/Datakit_client/Path/index.html#type-t">Datakit_client.Path.t</a> list</span>)</span> <a href="../index.html#type-result">result</a></span></code></dt><dd><p><code>merge t commit</code> merges <code>commit</code> into the transaction. It performs any trivial merges it can and returns <code>(merge_inputs,
        conflicts)</code> to allow you to resolve the remaining ones. You must write to each path in <code>conflicts</code> at least once before you can commit the transaction. You may perform multiple merges in one transaction, but the <code>merge_inputs</code> returned is only valid until the start of the next merge.</p></dd></dl><dl><dt class="spec value" id="val-parents"><a href="#val-parents" class="anchor"></a><code><span class="keyword">val</span> parents : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span><span><a href="../Commit/index.html#type-t">Commit.t</a> list</span> <a href="../index.html#type-result">result</a></span></code></dt><dd><p><code>parents t</code> is the parents of the transaction (that is, the parents of the commit that would be generated if you committed now.</p></dd></dl><dl><dt class="spec value" id="val-set_parents"><a href="#val-set_parents" class="anchor"></a><code><span class="keyword">val</span> set_parents : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span><a href="../Commit/index.html#type-t">Commit.t</a> list</span> <span>&#45;&gt;</span> <span>unit <a href="../index.html#type-result">result</a></span></code></dt><dd><p><code>set_parents t new_parents</code> replaces the current list of parents. Note that this does not perform a merge - it only affects the metadata. Note also that <code>merge</code> automatically updates the parents, so it is not necessary to call it manually in that case.</p></dd></dl><dl><dt class="spec value" id="val-conflicts"><a href="#val-conflicts" class="anchor"></a><code><span class="keyword">val</span> conflicts : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span><span><a href="../../../../../datakit-client/Datakit_client/Path/index.html#type-t">Datakit_client.Path.t</a> list</span> <a href="../index.html#type-result">result</a></span></code></dt><dd><p><code>conflicts t</code> returns the current list of paths that had merge conflicts and have not been written to since. It is not possible to commit while this is non-empty.</p></dd></dl><dl><dt class="spec value" id="val-diff"><a href="#val-diff" class="anchor"></a><code><span class="keyword">val</span> diff : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../Commit/index.html#type-t">Commit.t</a> <span>&#45;&gt;</span> <span><span><span><a href="../../../../../datakit-client/Datakit_client/Path/index.html#type-t">Datakit_client.Path.t</a> <a href="../../../../../datakit-client/Datakit_client/index.html#type-diff">Datakit_client.diff</a></span> list</span> <a href="../index.html#type-result">result</a></span></code></dt><dd><p><code>diff t c</code> returns the paths differences between <code>c</code> and <code>t</code>'s head.</p></dd></dl><dl><dt class="spec value" id="val-closed"><a href="#val-closed" class="anchor"></a><code><span class="keyword">val</span> closed : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> bool</code></dt><dd><p><code>closed t</code> is true if <code>t</code> is closed and thus it is not valid to read/write on it anymore.</p></dd></dl></section></div></body></html>